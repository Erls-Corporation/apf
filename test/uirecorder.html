<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:a="http://ajax.org/2005/aml" 
  xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>UIRecorder</title>
        <script src="../apf.js"></script>
        <script src="../loader.js"></script>
        <style type="text/css">
            body {
                overflow: hidden;
            }
            .cursor {
                position: absolute;
                left: -9999px;
                width: auto;
                height: 21px;
                background: transparent url("images/cursor_w.png") no-repeat;
            }
            .cursor .cursorMsg {
                position: relative;
                display: block;
                width: auto;
                left: 16px;
                font-size: 12px;
                color: #00F;
            }
            .cursor.click {
                background: transparent url("images/cursor_r.png") no-repeat;
            }
            .cursor.text {
                background: transparent url("images/cursor_text.png") no-repeat;
            }
            #previewActions {
                z-index: 9999999999;
            }
            .trail {
                position: absolute;
                width: 3px;
                height: 3px;
                background: #F00;
            }
        </style>
	</head>
	<body>
	    <a:skin src="../skins.xml" />
        
<a:model id="mdlItems">
    <items>
        <item>
            <name>John Doe</name>
            <subject>About those important documents.</subject>
            <message>I would really like them back!</message>
        </item>
    </items>
</a:model>

<a:actions id="actExample">
    <a:add>
        <item />
    </a:add>
    <a:update />
</a:actions>

<a:button 
  caption = "Add"
  right   = "10" 
  top     = "10"
  onclick = "popupWindow.begin('add')" />
<a:button id="btn1"
  caption  = "Undo"
  right    = "10"
  top      = "40"
  disabled = "{!atTransTest1.undolength}" 
  onclick  = "atTransTest1.undo()" />
<a:button id="btn2"
  caption  = "Redo"
  right    = "10"
  top      = "70"
  disabled = "{!atTransTest1.redolength}" 
  onclick  = "atTransTest1.redo()" />

<a:label height="20">Double click on an item to edit it</a:label>
<a:datagrid 
  id      = "dgItems" 
  width   = "525" 
  height  = "100" 
  model   = "mdlItems" 
  actions = "actExample"
  actiontracker ="atTransTest1"
  onafterchoose = "popupWindow.show()">
    <a:each match="[item]">
        <a:column type="icon" value="note.png" width="18"/>
        <a:column caption="Name" value="[name]" width="30%"/>
        <a:column caption="Subject" value="[subject]" width="70%"/>
    </a:each>
</a:datagrid>

<a:window 
  id          = "popupWindow" 
  transaction = "true"
  kbclose     = "true"
  popout      = "true"
  buttons     = "min|max|close" 
  width       = "300" 
  height      = "300" 
  center      = "true"
  minwidth    = "300" 
  minheight   = "290"
  resizable   = "true"
  realtime    = "true" 
  title       = "Message" 
  icon        = "note.png" 
  model       = "{dgItems.selected}">
    <a:table 
      columns = "80, *" 
      margin  = "10 10 10 10" 
      padding = "5" 
      bottom  = "35" 
      top     = "0">
        <a:label>Name</a:label>
        <a:textbox value="[name]" id="txt"
          required   = "true" 
          invalidmsg = "Missing name;The name field is required" />
        <a:label>Subject</a:label>
        <a:textbox value="[subject]" />
        <a:label span="*">Message</a:label>
        <a:textarea value="[message]" 
            height = "*" 
            span   = "*"/>
    </a:table>
    
    <a:button 
      action  = "ok"
      default = "true"
      right   = "170"
      bottom  = "10"
      width   = "75">OK</a:button>
        
    <a:button 
      action  = "cancel"
      right   = "90"
      bottom  = "10"
      width   = "75">Cancel</a:button>
    
    <a:button 
      action   = "apply"
      right    = "10"
      bottom   = "10"
      width    = "75"
      disabled = "{!popupWindow.undolength}">Apply</a:button>
</a:window>
<!--
        <a:window  
            id          = "window1"
            buttons     = "min|max|close"
            title       = "Window"
            visible     = "true"
            resizable   = "true" 
            width       = "200"
            height      = "190"
            minwidth    = "170"
            minheight   = "150"> 
        </a:window>

        <a:textbox id="textbox1"></a:textbox>

        <a:window id="tabWindow" 
          visible = "true" 
          width   = "400" 
          height  = "150" 
          title   = "Simple Tab" 
          icon    = "application_view_icons.png">
            <a:tab id="tabs" anchors="10 10 10 10"> 
                <a:page id="page1" caption="General"> 
                    <a:checkbox>Example</a:checkbox> 
                    <a:button>Example</a:button> 
                </a:page> 
                <a:page id="page2" caption="Advanced"> 
                    <a:checkbox>Test checkbox</a:checkbox> 
                    <a:checkbox>Test checkbox</a:checkbox> 
                    <a:checkbox>Test checkbox</a:checkbox> 
                </a:page> 
                <a:page id="page3" caption="Ajax.org"> 
                    <a:checkbox>This ok?</a:checkbox> 
                    <a:checkbox>This better?</a:checkbox> 
                </a:page> 
            </a:tab> 
        </a:window>

        <a:button id="action1Btn" onclick="action1()" 
          bottom="50" left="10">
            Action 1
        </a:button>
-->
        <a:button id="recBtn" onclick="record()" 
          bottom="10" left="10">
            Record
        </a:button>

        <a:button id="stopBtn" onclick="stop()" disabled="true" 
          bottom="10" left="130">
            Stop
        </a:button>

        <a:button id="clrBtn" onclick="clear()" 
          bottom="10" left="250">
            Clear
        </a:button>

        <a:button id="getEventsBtn" onclick="createXml()" 
          bottom="10" left="370">
            Create XML
        </a:button>

        <a:button id="playBtn" onclick="play()" 
          bottom="10" left="490">
            Play
        </a:button>

        <a:tree 
            id              = "treeEvent" 
            model           = "mdlEvent"
            left            = "300"
            width           = "300"
            height          = "600"
            startcollapsed  = "false"
        >
            <a:each match="[element|event]">
                <a:caption match="[@caption]" />
            </a:each>
        </a:tree>
        <a:model id="mdlEvent">
            <data></data>
        </a:model>


        <a:tree 
            id              = "treeAction"
            model           = "mdlAction" 
            width           = "300"
            height          = "600"
            onafterselect   = "selectAction()"
            multiselect     = "true" 
        >
            <a:each match="[action]">
                <a:caption match="[@caption]" />
            </a:each>
        </a:tree>
        <a:model id="mdlAction">
            <data></data>
        </a:model>

        <a:table id ="tableTest"
          columns   = "50, *"
          model     = "{treeAction.selected}"
          margin    = "40 10 40 10" 
          padding   = "5"
          width     = "400"
        >
            <a:label>Movement</a:label>
            <a:dropdown 
                id              = "dropdownMovement" 
                value           = "[property[@name='movement']/@value]"
                initial-message = "Select"
                disabled        = "true"
            >
                 <a:item value="realtime">realtime</a:item>
                 <a:item value="lineair">lineair</a:item>
            </a:dropdown>
            <a:label>Click position</a:label>
            <a:dropdown 
                id              = "dropdownClickPos" 
                value           = "[property[@name='clickpos']/@value]"
                initial-message = "Select"
                disabled        = "true"
            >
                 <a:item value="position">position</a:item>
                 <a:item value="element">element</a:item>
            </a:dropdown>
            
            <a:button id="btnSave" onclick="saveProperties()" disabled="true">Save</a:button>
        </a:table>
        
        <a:textarea
            id="textareaXml"
            top = "150"
            right = "50"
            width = "500"
            height = "700"
        >
        </a:textarea>
        <!--
        <a:textbox id="textbox1"></a:textbox>
        -->
        <a:textbox left="600"></a:textbox>
        
        <a:label>PlaySpeed</a:label>
        <a:dropdown 
            id              = "dropdownPlaySpeed" 
            value           = "1"
            onslideup       = "changeSpeed()"
        >
            <a:item value="0.5">0.5</a:item>
            <a:item value="1.0">1.0</a:item>
            <a:item value="1.5">1.5</a:item>
            <a:item value="2.0">2.0</a:item>
            <a:item value="3.0">3.0</a:item>
            <!--
            <a:item value="4.0">4.0</a:item>
            <a:item value="5.0">5.0</a:item>
            -->
        </a:dropdown>


<!--
        <a:datagrid 
          width     = "400" 
          height    = "200" 
          id        = "datagridProperties"
          model     = "{treeAction.selected}"
        >
            <a:each match="[property]"> 
                <a:column 
                  caption = "Property" 
                  value   = "[@name]"
                  width   = "100%" /> 
                <a:column
                  caption = "Value" 
                  width   = "180" 
                  value   = "[@value]">
                </a:column>
            </a:each> 
            <a:actions /> 
        </a:datagrid>
-->
        <a:script>//<!--
            mdlEventData = apf.getXml("<data />");
            mdlActionData = apf.getXml("<data />");

            // start capturing events
            function record(){
                document.getElementById("previewActions").innerHTML = "";
                //start recording user actions
                apf.uirecorder.record();
        
                recBtn.setAttribute('disabled', apf.uirecorder.isRecording);
                stopBtn.setAttribute('disabled', !apf.uirecorder.isRecording);
            }

            // stop capturing events
            function stop(){
                //start recording user actions
                apf.uirecorder.stop();
        
                recBtn.setAttribute('disabled', apf.uirecorder.isRecording);
                stopBtn.setAttribute('disabled', !apf.uirecorder.isRecording);
                
                loadActionList();
                loadActionXml();
                //debugger;
            }
            
            function loadActionXml() {
                textareaXml.setProperty("value", apf.uirecorder.actionsXml.xml);
            }
            function selectAction() {
                showActions();
                loadEventList();
            }
            
            function showActions() {    
                var items = treeAction.selection;
                
                var previewActions = document.getElementById("previewActions");
                previewActions.innerHTML = "";
                var enableDdMovement = true;
                var enableDdClickPos = true;
                for (var item, ii = 0, il = items.length; ii < il; ii++) {
                    var cursor = createCursor();
                    var cursorMsg = cursor.getElementsByTagName("span")[0];
                    document.getElementById("previewActions").appendChild(cursor);
                
                    item = items[ii];
                    action = apf.uirecorder.actionList[item.getAttribute("index")];
                    if (action.name != "mousemove") {
                        enableDdMovement = false;
                    }
                    if (action.name != "click") {
                        enableDdClickPos = false;
                    }
                    if (action.name == "mousemove") {
                        var grouped = [];
                        var firstAction = action;

                        var movement = action.movement;
                        var trailIncr = 1;
                        var prevAction;
                        for (var ci = 0, cl = firstAction[movement].length-1; ci < cl; ci++) {
                            action = firstAction[movement][ci];
//                            if (prevAction && (action.x < prevAction.x - 5 || action.x > prevAction.x + 5)) debugger;
                            if (action.name != "mousemove") debugger;
                            grouped.push(action);
                            
                            prevAction = action;
                        }
                        
                        for (var gi = 0, gl = grouped.length; gi < gl; gi += trailIncr) {
                            action = grouped[gi];
                            // create new trailpoint
                            div = document.createElement("div");
                            div.setAttribute("class", "trail");
                            div.style.top = action.y + "px";
                            div.style.left = action.x + "px"; 
                            div.style.opacity = gi / grouped.length;
                            previewActions.appendChild(div);
                        }
    
                        cursor.style.top = action.y + "px";
                        cursor.style.left = action.x + "px";
                        cursor.setAttribute("class", "cursor");
                        cursorMsg.innerHTML = action.name + " (" + firstAction.x + ", " + firstAction.y + ") to (" + action.x + ", " + action.y + ")";
                    } 
                    else if (item.getAttribute("type") == "click") {
                        cursor.style.top = action.y + "px";
                        cursor.style.left = action.x + "px";
                        cursor.setAttribute("class", "cursor click");
                        cursorMsg.innerHTML = action.name + " (" + action.x + ", " + action.y + ")";
                    }
                }
                
                dropdownMovement.setProperty("disabled", !enableDdMovement);
                dropdownClickPos.setProperty("disabled", !enableDdClickPos);
                btnSave.setProperty("disabled", !enableDdMovement && !enableDdClickPos);
            }

            //<div class="cursor"><span class="cursorMsg">Message</span></div>
            function createCursor() {
                var cursor = document.createElement("div");
                cursor.setAttribute("class", "cursor");
                
                var cursorMsg = document.createElement("span");
                cursorMsg.setAttribute("class", "cursorMsg");
                
                cursor.appendChild(cursorMsg);
                
                return cursor;
            }
            
            function loadActionList() {
                // get action list
                mdlActionData = apf.getXml("<data />");
                for (var prevActionName, action, actionNode, groupedNode, childNode, propertyNode, i = 0, l = apf.uirecorder.actionList.length; i < l; i++) {
                    action = apf.uirecorder.actionList[i];

                    actionNode = mdlEventData.ownerDocument.createElement("action");
                    actionNode.setAttribute("x", action.x);
                    actionNode.setAttribute("y", action.y);
                    actionNode.setAttribute("type", action.name);
                    actionNode.setAttribute("index", i);
                    
                    caption = (["mousemove","click"].indexOf(action.name) > -1) 
                        ? action.name + " (" + action.x + ", " + action.y + ")" 
                        : action.name == "keypress"
                            ? action.name + " (" + action.value + ")"
                            : action.name;
                            
                    actionNode.setAttribute("caption", caption);
                    //actionNode.appendChild(mdlActionData.ownerDocument.createTextNode(action.name));

                    if (action.name == "mousemove") {
                        propertyNode = mdlEventData.ownerDocument.createElement("property");
                        propertyNode.setAttribute("name", "movement");
                        propertyNode.setAttribute("value", action.movement);
                        actionNode.appendChild(propertyNode);
                    }
                    else if (action.name == "click") {
                        propertyNode = mdlEventData.ownerDocument.createElement("property");
                        propertyNode.setAttribute("name", "clickpos");
                        propertyNode.setAttribute("value", action.clickpos);
                        actionNode.appendChild(propertyNode);
                    }

                    mdlActionData.appendChild(actionNode);
                    prevActionName = action.name;
                }

                mdlAction.load(mdlActionData.xml);            
            }
            
            function loadEventList() {
                if (!treeAction.selection.length) return;
                var items = treeAction.selection;
                if (items.length > 1) return;
                
                var item = items[0];
                var action = apf.uirecorder.actionList[item.getAttribute("index")];
                var eventList = action.eventList;
                mdlEventData = apf.getXml("<data />");
                var elementNode, caption;
                for (var elementName in eventList) {
                    if (typeof eventList[elementName] != "object") continue;
                    
                    elementNode = mdlEventData.ownerDocument.createElement("element");
                    caption = (action.amlNode && action.amlNode.localName == "button") ? elementName + " (" + action.amlNode.caption + ")" : elementName; 
                    elementNode.setAttribute("caption", caption);
 
                    for (var eventNode, i = 0, l = eventList[elementName].length; i < l; i++) {
                        var event = eventList[elementName][i];
                        eventNode = mdlEventData.ownerDocument.createElement("event");
                        eventNode.setAttribute("caption", event.name);
                        elementNode.appendChild(eventNode);
                    }
                    
                    mdlEventData.appendChild(elementNode);
                }
                mdlEvent.load(mdlEventData.xml);
            }
            
            function saveProperties() {
                var items = treeAction.selection;
                
                for (var item, i = 0, l = items.length; i < l; i++) {
                    item = items[i];
                    
                    if (item.getAttribute("type") == "mousemove") {
                        var propertyNode = item.selectSingleNode("property[@name='movement']");
                        apf.xmldb.setAttribute(propertyNode, "value", dropdownMovement.value);
        
                        if (dropdownMovement.value === "lineair")
                            apf.uirecorder.addLineairMovement(item.getAttribute("index"));
                        apf.uirecorder.actionList[item.getAttribute("index")].movement = dropdownMovement.value;
                    }
                    else if (item.getAttribute("type") == "click") {
                        var propertyNode = item.selectSingleNode("property[@name='clickpos']");
                        apf.xmldb.setAttribute(propertyNode, "value", dropdownClickPos.value);
        
                        apf.uirecorder.actionList[item.getAttribute("index")].clickpos = dropdownClickPos.value;
                    } 
                    //loadActionList();
                    //treeAction.clearSelection();
                    //treeAction.select(item);
                }
                
                showActions();
                apf.uirecorder.setPlayList();
                loadActionXml();
            }
            
            function clear() {
                mdlActionData = apf.getXml("<data />");
                mdlAction.load(mdlActionData.xml);
                mdlEventData = apf.getXml("<data />");
                mdlEvent.load(mdlEventData.xml);
            }
            
            function play() {
                apf.uirecorder.play(textareaXml.value);
            }

            function createXml() {
                apf.uirecorder.createPlayList();
            }
            
            function changeSpeed() {
                apf.uirecorder.playSpeed = dropdownPlaySpeed.value;
            }
        //--></a:script>

        <div id="status">
            
        </div>
        
        <div id="previewActions" />
        <!--
        <div class="cursor"><span class="cursorMsg">Message</span></div>
        -->
	</body>
</html>
