<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>JSLT2 Example</title>
    <style>
    	body, button{
    		font-family : Myriad Web, Arial;
    	}
    
    	body{
    		margin : 20px;
    	}
    	
    	P{
    		font-size : 9pt;
    		background-color : #EEEEEE;
    		padding : 10px;
    		border-left : 1px solid #DDDDDD;
    	}
    	
    	h1{
    		color : orange;
    	}
    	
    	h2{
    		margin-bottom : 0;
    		font-size : 14pt;
    		color : midnightblue;
    	}
    	
    	.float{
    		float : left;
    		width : 49%;
    	}
    	
    	.float textarea{
    		width : 95%;
    		height : 180px;
    		border : 1px solid gray;
    	}
    	
    	label{
    		font-size : 8pt;
    		position : relative;
    		top : -1px;
    	}
    	
    	button{
    		border-width : 1px;
    		padding : 2px;
			float:left;
    	}
		#taJslt{
			color: blak;
		}
		#taXml{
			color: red;
		}    
		#taResult{
			color: green;
		}   
		#taCode{
			color: gray;
		}   
    </style>
		<script >//<![CDATA[

        window.onload = function(){
                // lets parse the XML, and JSLT
                doJsltProcessing(0);

            }

            var xmlData;
            var jsltCode;

            function setCode(x){document.getElementById('taCode').value = x;}
            function setResult(x){document.getElementById('taResult').value = x;}
            function getJslt(){return document.getElementById('taJslt').value;}
            function getXml(){ return document.getElementById('taXml').value;}


            function doParseXML(){
                try{ xmlData = parseXML(getXml());}
                catch(e){
                    xmlData= null;
                }
                if(!xmlData || !xmlData.documentElement)setResult("XML Parsing error occured\n");
                
            }

            function doCompileJSLT(){
            
                clearLog();
                try{
                    var jslt = getJslt();
                    //jsltCode = JSLT.compile(jslt,true);
                    //var dt = (new Date()).getTime();
                    //for(var i = 0;i<1000;i++)
                    var call = 'compileTest', opts = [];
                    jslt = jslt.replace(/^(\d+|\w+)\s*(\(.*?\))\s*[\r\n]+?/i,function(m,a,o){
                        call = 
                        ({value:'compileValue',node:'compileNode',event:'compileEvent',di:'compileDataInstruction',match:'compileMatch',
                        0:'compileValue',    1:'compileNode',   2:'compileEvent',    3:'compileDataInstruction', 4:'match'})[a];
                        if(!call){ call = 'compileTest'; return m;}
                        opts = o?o.slice(1,-1).split(/,/):[];
                        for(var i = 0,j = opts.length;i<j;i++)if(parseInt(opts[i])==opts[i])opts[i] = parseInt(opts[i]);
                        return "";
                    });
                    var v, args = (v=apf.jslt[call].toString().match(/function\(\s*str\s*,\s*(.*?)\)/))?v[1].split(','):[];
                    for(var i =0, s=[] ;i<args.length;i++)
                        s.push(args[i]+' = '+(opts[i]===undefined?'undefined':opts[i]));
                    logw("apf.jslt."+call+"(str = '..', "+s.join(', ')+")");
                    opts.unshift(jslt);
                    
                    if(call == 'compileMatch'){
                        var a = opts[0].split(/[\r\n]+/), b = opts[0] = [], c;
                        for(i = 0;i<a.length;i++){
                            c = a[i].split('#');
                            b[b.length] = c[0] || "";
                            b[b.length] = c[1] || "";
                        }
                        jsltCode = apf.jslt[call].apply(apf.jslt,opts);
                    }else{
                        jsltCode = apf.jslt[call].apply(apf.jslt,opts);
                    }
                 }
                catch(e){
                    setResult("JSLT Compilation occured:\n"+e.message);
                    jsltCode = null;
                }
                setCode(apf.jslt.lastCode());
            }

            // do the processing
            function doJsltProcessing(x){
                if(!xmlData || x&1)doParseXML();
                if(!xmlData || !xmlData.documentElement)return;
                if(!jsltCode || x&2)doCompileJSLT();
                var obj = {v1:3};
                try{ 
                    if(jsltCode)setResult("all clear");
                /*
                    if( typeof(jsltCode) == 'string'){
                        setResult("Plain Text: "+jsltCode);
                    }else if(jsltCode){
                        if(jsltCode[0]){
                            if(jsltCode[3]&4){ // async
                                // hm async shiz. lezz precall.
                                //var opt = {_precall:1}
                                //jsltCode[0](xmlData.documentElement,null,opt);
                                
                                //opt._precall = 0;
                                jsltCode[0](xmlData.documentElement,function(v){
                                    setResult( 'Async received:'+v );
                                    // jsltCode[0](xmlData.documentElement,function(v){
                                    //     setResult( 'Async2 received:'+v );
                                    // });
                                });
                                
                            }else{
                                setResult("Immediate:"+jsltCode[0](xmlData.documentElement));
                            }
                        }
                        else{
                            setResult("Plain Xpath: Model: " +jsltCode[1][0]+" Xpath: "+jsltCode[1][1]);
                        }
                    }
                    */
                }
                catch(e){
                   setResult("JSLT Execution occured:\n"+e.message);
                }
            }

            // util function
            function parseXML(x){			
                var p;	
                if(document.all){p = new ActiveXObject("microsoft.XMLDOM");p.setProperty("SelectionLanguage", "XPath");p.loadXML(x);}
                else{p = new DOMParser();if(x) p = p.parseFromString(x, "text/xml");}
                return p;
            }

            function clearLog(){
                var e = document.getElementById('dbgLog');
                if(1)e.innerHTML = "";
            }

            var ts=[],ti;
            function logw(txt){
                var e = document.getElementById('dbgLog');
                if(!e){
                  if(txt===undefined)return txt;
                  ts.push(txt);ts.push('\n');
                  window.setTimeout("logw()",100);
                  return txt;
                }
                
                if(txt===undefined){if(!ts)return txt;txt = ts.join('');ts=null;}
                var t = (txt+'').replace(/ /g, "&nbsp;").replace(/\</g, "&lt;").replace(/\>/g, "&gt;").replace(/\n/g, "<br/>").replace(/\t/g, "&nbsp;&nbsp;&nbsp;")+"<br/>";
                e.innerHTML += t;
              //  e.insertAdjacentHTML("beforeend", t);
                e.scrollTop = e.scrollHeight;
                return txt;
            }

            function test(x){
                return x;
            }
            
            var apf = {
                SUCCESS:1,
                console:{error:logw},
                getXml:function(str){
                        return parseXML(str).documentElement;
                },
                createNodeFromXpath:function(a,b){ return {};},
                nameserver:{lookup:{model:{}}}
            };
            var rpc = {
                exec : function(func,args,cb){
                    window.setTimeout(function(){
                        cb( rpc[func].call(func,args), 1, 0);
                    },1000);
                },
                test : function(a){
                    return "<xml><drive><folder caption='hello'/></drive></xml>"+a;
                }
            }
        
        //]]></script>
		<script src='../core/parsers/lm.js'></script>
  </head>
  <body>
  	<h1>Realtime JSLT Example</h1>
  	
  	<p>
		Below you can try out entering test XML data and a piece of JSLT. With every keystroke the application will try to compile your JSLT and execute it to form the output. The output is 'plain flat text' in this case to make it more clear what it outputs. It is of course trivial to have it output to an 'innerHTML' part of a div, for it to update HTML in real-time. Please note this example is completely javascript based, and does not use any server-side component. Please check this <a target="_blank" href='http://www.rikarends.com/jslt-alternative-to-xslt'>article</a> for more information. You can also <a href='http://www.rikarends.com/source/jslt_example.zip'>download</a> this example. You see a few \n and \s characters in the example below, that is just to insert whitespace(\s) and newlines (\n) into the output as it is plaintext
and not HTML where you would use nbsp and br tags. Take special note of the % character in a [code] block. This character actually outputs what follows to the output buffer.  Doing [%(4+10)] will output 14 into the buffer. Doing %#'file' in a codeblock outputs the 'number of nodes' matched by the file xpath into the output buffer. When you encounter a compile error with good looking code, check if you have a missing ; somewhere. Improving ; insertion and space removal is still on the improvement list. Email or MSN me on rik at javeline.nl if you have any questions.
	</p>
  	
  	<div class="float">
	  	<h2>XML</h2>
		<textarea id='taXml' onkeyup='if(!document.getElementById("nort").checked)doJsltProcessing(1)'>
<xml>
 <folder name='F1'>
  <file>C</file>
  <file>A</file>
  <file>B</file>
 </folder>
 <folder name='F2'>
  <file>D</file>
 </folder>
 <folder name='F2'>
  <file>F</file>
  <file>A</file>
 </folder>
</xml>
</textarea>

	</div>
	<div class="float">
		<h2>JSLT</h2>
		<textarea id='taJslt' onkeyup='if(!document.getElementById("nort").checked)doJsltProcessing(2)'>
        [rpc.test()]
</textarea>

	</div>
	<div class="float">
		<h2>Output</h2>
		<textarea id='taResult'></textarea>
	</div>
	<div class="float">
		<h2>Generated code</h2>
		<textarea id='taCode'></textarea>
	</div>
	<button onclick='doJsltProcessing(3)'>Update</button>
	<input id='nort' type="checkbox"><label>Don't update in real-time.</label></input><br /><br />
    <div id='dbgLog' style="width:100%;height:500px;overflow-y:scroll;overflow-x:scroll;white-space:break-word;background-color:black;color:gray;font-family:courier;font-size:8pt;">
    </div>
    </body>
  
</html>