<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:a="http://ajax.org/2005/aml" 
  xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <script src="../../apf.js"></script>
        <style>
            html{overflow:hidden}
        </style>
	</head>
	<body>
	    <a:skin src="../../skins.xml" />

        <a:defaults for="window"
            draggable = "false"
            dockable  = "true"
            dock      = "true" />

        <a:bar id="uir_bar" skin="basic" style="border:1px solid gray" align="left-splitter" height="70%"></a:bar>
        <a:window
            id = "uir_windowControls"
            title = "Controls"
            buttons = "min"
            align="right-splitter"
            width = "200"
            visible = "{!uir_windowStop.visible}"
        >
            <a:button id="uir_btnRecord" onclick="record()">Record</a:button>
            <a:button id="uir_btnPlay" onclick="play()" disabled="true">Play</a:button>
            <a:button id="uir_btnTest" onclick="play(true)" disabled="true">Test</a:button>
            <a:button id="uir_btnClear" onclick="clearTests()" disabled="true">Clear</a:button>
            <a:label>Speed</a:label>
            <a:dropdown id="uir_ddRealtime" value="realtime">
                <a:item value="realtime">realtime</a:item>
                <a:item value="max">max</a:item>
            </a:dropdown>
        </a:window>

        <a:window
            id = "uir_windowStop"
            title = "Controls"
            align="right-splitter"
            width = "200"
            visible = "{uir_btnRecord.disabled}"
        >
            <a:button id="uir_btnStop" onclick="stop()">Stop</a:button>
    
        </a:window>        
        <a:window 
            id="uir_windowTests"
            title = "Tests"
            buttons = "min"
            align="right-splitter"
            height = "40%"
            visible = "false"
        >
            <a:list
                id = "uir_listTests"
                model = "uir_mdlTests"
                anchors = "0 0 0 0"
            >
                <a:each match="[test]">
                    <a:caption value="[@name] ([@status])" />
                </a:each>
            </a:list>
            
            <a:model 
                id="uir_mdlTests" />
        </a:window>
        
        <a:window 
            id="uir_windowChanges"
            title = "Changes"
            buttons = "min"
            align="left-splitter"
            visible = "false"
        >
            <a:datagrid
                id = "uir_dgChanges"
                model = "uir_mdlChanges"
                anchors = "0 0 0 0"
            >
                
                <a:each match="[change]">
                    <a:column
                        caption     = "Test" 
                        value       = "[test/text()]" 
                        width       = "60px"
                    />
                    <a:column
                        caption     = "Element" 
                        value       = "[element/text()]" 
                        width       = "500px"
                    />
                    <a:column
                        caption     = "Type" 
                        value       = "[type/text()]" 
                    />
                    <a:column
                        caption     = "Name" 
                        value       = "[name/text()]" 
                    />
                    <a:column
                        caption     = "Capture value" 
                        value       = "[capture/text()]" 
                    />
                    <a:column
                        caption     = "Testing value" 
                        value       = "[result/text()]" 
                    />
                </a:each>
            </a:datagrid>
            
            <a:model 
                id="uir_mdlChanges" />
        </a:window>
        <a:script>//<!--
            var o3 = window.external.o3;
            var hostWnd = o3.window;
            //hostWnd.showButtons = false;
            hostWnd.showButtons = true;
            hostWnd.caption = "APF 3 UIRecorder"  
            hostWnd.x = 0;
            hostWnd.y = 0;
            hostWnd.width = 1600;     
            hostWnd.height = 1000;
            //hostWnd.minimize();        
            hostWnd.restore();
            
            apf.uirecorder.load('markup.xml');
            
            function play(isTest) {
                uir_btnPlay.setAttribute("disabled", true);

                if (isTest)
                    apf.uirecorder.test();
                for (var test, testStatus, prevTime = 0, i = 0, l = apf.uirecorder.testListXml.childNodes.length; i < l; i++) { //startTime 
                    apf.uirecorder.load('markup.xml');
                    
                    // @todo wait for uir_bar markup is processed
                    o3.wait(100);
                    test = apf.uirecorder.testListXml.childNodes[i];
                    //startTime = new Date().getTime();
/*
                    apf.xmldb.setAttribute(apf.uirecorder.testListXml.childNodes[i], "status", "playing");
                    uir_mdlTests.load(apf.uirecorder.testListXml.xml);
                    testStatus = "success";
*/

                    // loop through actions
                    for (var elapsedTime, action, ai = 0, al = test.childNodes.length; ai < al; ai++) {
                        action = test.childNodes[ai];
                        
                        if (uir_ddRealtime.value === "realtime") {
                            //elapsedTime = new Date().getTime() - startTime;
                            //o3.wait((parseInt(action.getAttribute("time"))-elapsedTime)/10);
                            
                            o3.wait((parseInt(action.getAttribute("time"))-prevTime)/20);
                            prevTime = parseInt(action.getAttribute("time"));
                        }
                        o3.mouseTo(parseInt(action.getAttribute("x")) + hostWnd.clientX, parseInt(action.getAttribute("y")) + hostWnd.clientY, hostWnd);
                        
                        if (action.getAttribute("name") === "click") {
                            o3.mouseLeftClick();
                        }
                        else if (action.getAttribute("name") === "keypress") {
                            o3.sendKeyEvent(action.getAttribute("value"));
                        }
                        else if (action.getAttribute("name") === "mousedown") {
                            //o3.mouseLeftUp();
                        }
                        else if (action.getAttribute("name") === "mouseup") {
                            //o3.mouseLeftUp();
                        }
                    }
/*                    
                    apf.xmldb.setAttribute(apf.uirecorder.testListXml.childNodes[i], "status", testStatus);
                    uir_mdlTests.load(apf.uirecorder.testListXml.xml);
*/                    
                    uir_btnPlay.setAttribute("disabled", false);

                    if (isTest)
                        apf.uirecorder.save("results");
                }
                
                if (isTest) {
                    apf.uirecorder.stop();
                    uir_windowChanges.setProperty("visible", true);
                    uir_mdlChanges.load(apf.uirecorder.changesXml.xml);
                }
            }
            
            function record() {
                uir_bar.replaceMarkup('markup.xml');
                apf.uirecorder.record();
                
                uir_windowTests.setProperty("visible", false);
                uir_windowChanges.setProperty("visible", false);
                uir_btnRecord.setAttribute("disabled", true);
            }
            
            function stop() {
                apf.uirecorder.stop();
                
                uir_windowTests.setProperty("visible", true);
                uir_btnPlay.setAttribute("disabled", false);
                uir_btnRecord.setAttribute("disabled", false);
                uir_btnTest.setAttribute("disabled", false);
                uir_btnClear.setAttribute("disabled", false);

                uir_mdlTests.load(apf.uirecorder.testListXml.xml);
            }
            
            function clearTests() {
                apf.uirecorder.resetTests();

                uir_btnPlay.setAttribute("disabled", true);
                uir_btnTest.setAttribute("disabled", true);
                uir_btnClear.setAttribute("disabled", true);
                
                uir_mdlTests.load(apf.uirecorder.testListXml.xml);
            }
        //--></a:script>
	</body>
	<script>
	         
	    /*
        document.getElementById("firstname").focus();        
        
	o3.sendKeyEvent("[SHIFT]abrakadabra");
	o3.wait(100);
	o3.sendKeyEvent("\tabrakadabra");
        o3.mouseTo(50 + hostWnd.clientX,250 + hostWnd.clientY,hostWnd);
        o3.mouseLeftClick();
*/

	</script>
</html>