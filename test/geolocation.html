<!doctype html>
<html xmlns:a="http://ajax.org/2005/aml" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>GeoLocation testing</title>
        <script type="text/javascript" src="../apf.js"></script>
        <script src="http://code.google.com/apis/gears/gears_init.js" type="text/javascript" charset="utf-8"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    </head>
    <body>
        <a:skin src="../skins.xml" media-path="../images/" icon-path="../icons/" />
        
        <a:appsettings debug="0" />
        
        <div id="status">Click the button...</div>
        <div id="map_canvas" style="width:320px; height:350px"></div>
        
        <a:button id="btnTest" onclick="testGeo()">Get Location!</a:button>
        <a:script><![CDATA[
            var map, testing, last_position = null;

            function testGeo() {
                if (testing) {
                    clearInterval(testing);
                    document.getElementById("status").innerHTML = "On hold.";
                    btnTest.setCaption("Get Location!");
                    return;
                }
                if (!apf.hasGeoLocation()) {
                    document.getElementById("status").innerHTML = "Functionality not available";
                    return;
                }

                btnTest.setCaption("Stop");

                map = new google.maps.Map(document.getElementById("map_canvas"), {
                    zoom                    : 15,
                    mapTypeControl          : true,
                    mapTypeControlOptions   : {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
                    navigationControl       : true,
                    navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
                    mapTypeId               : google.maps.MapTypeId.HYBRID
                });

                retrieve();
            }

            function retrieve() {
                clearInterval(testing);
                document.getElementById("status").innerHTML = "Retrieving location...";
                apf.geolocation.getCurrentPosition(show_position, function(){
                    document.getElementById("status").innerHTML = "Couldn't get location";
                });
                testing = setInterval(retrieve, 10000);
            }

            function show_position(p) {
                if (last_position && last_position.coords.latitude == p.coords.latitude
                  && last_position.coords.longitude == p.coords.longitude) {
                    document.getElementById("status").innerHTML = "User has not moved, checking again in 10s";
                    return;
                }

                last_position = p;
                document.getElementById("status").innerHTML = "latitude=" + p.coords.latitude.toFixed(2)
                    + " longitude=" + p.coords.longitude.toFixed(2);
                var pos = new google.maps.LatLng(p.coords.latitude, p.coords.longitude);
                map.setCenter(pos);

                var infowindow = new google.maps.InfoWindow({
                    content: "<strong>yes</strong>"
                });

                var marker = new google.maps.Marker({
                    position: pos,
                    map     : map,
                    title   : "You are here"
                });

                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map,marker);
                });
            }
        ]]></a:script>
    </body>
</html>